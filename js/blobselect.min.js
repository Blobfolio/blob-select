/**
*
* blobSelect
* version: 0.7
* home: https://blobfolio.com
*
* use:
*	<select data-blobselect="{OPTIONS}">
*	select fields with the data-blobselect attribute are auto-initialized on load
*	select fields can be manually initialized with:
*		new blobSelect(getElementById('the-field'))
*
* options:
*	orderType (string, numeric, null)
*		(string)
*		options will be resorted based on their values
*		default: null (i.e. no sort)
*	order (ASC, DESC)
*		(string)
*		options will be resorted up or down
*		default: ASC
*	placeholder (string)
*		mimics an input's placeholder attribute; this text is displayed when the
*		selection has no label
*		default: ---
*	placeholderOption (string)
*		this text is used when an option has no label
*		default: ---
*	search (bool)
*		a contentEditable field is placed at the top of the menu
*		to allow users to filter results
*		default: false
*
**/
(function(){if(!("classList" in document.documentElement)||!("createRange" in document)||!("querySelector" in document&&"querySelectorAll" in document)||!("JSON" in window&&"parse" in JSON&&"stringify" in JSON)){console.warn("blobSelect["+new Date().toISOString().slice(0,19).replace("T"," ")+"] aborted; browser missing feature support");return}if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(t){var u=(this.document||this.ownerDocument).querySelectorAll(t),r=u.length;while(--r>=0&&u.item(r)!==this){}return r>-1}}function f(A,w){var B,C,y,s,v,r,t,z,x,u;B=A.length&3;C=A.length-B;y=w;v=3432918353;t=461845907;u=0;while(u<C){x=((A.charCodeAt(u)&255))|((A.charCodeAt(++u)&255)<<8)|((A.charCodeAt(++u)&255)<<16)|((A.charCodeAt(++u)&255)<<24);++u;x=((((x&65535)*v)+((((x>>>16)*v)&65535)<<16)))&4294967295;x=(x<<15)|(x>>>17);x=((((x&65535)*t)+((((x>>>16)*t)&65535)<<16)))&4294967295;y^=x;y=(y<<13)|(y>>>19);s=((((y&65535)*5)+((((y>>>16)*5)&65535)<<16)))&4294967295;y=(((s&65535)+27492)+((((s>>>16)+58964)&65535)<<16))}x=0;switch(B){case 3:x^=(A.charCodeAt(u+2)&255)<<16;case 2:x^=(A.charCodeAt(u+1)&255)<<8;case 1:x^=(A.charCodeAt(u)&255);x=(((x&65535)*v)+((((x>>>16)*v)&65535)<<16))&4294967295;x=(x<<15)|(x>>>17);x=(((x&65535)*t)+((((x>>>16)*t)&65535)<<16))&4294967295;y^=x}y^=A.length;y^=y>>>16;y=(((y&65535)*2246822507)+((((y>>>16)*2246822507)&65535)<<16))&4294967295;y^=y>>>13;y=((((y&65535)*3266489909)+((((y>>>16)*3266489909)&65535)<<16)))&4294967295;y^=y>>>16;return y>>>0}var j=function(s,r){if(!s){return null}return typeof s==="string"?(r||document).querySelector(s):s};var q=function(s,r){return Array.prototype.slice.call((r||document).querySelectorAll(s))};var e=function(s,t){var r={};k(s,function(v,u){r[u]=s[u]});k(t,function(v,u){r[u]=t[u]});return r};var b=function(s,r){try{if(s.matches(r)){return s}while(s.parentNode&&"matches" in s.parentNode){s=s.parentNode;if(s.matches(r)){return s}}}catch(t){}return null};var k=function(t,u){if(Object.prototype.toString.call(t)==="[object Object]"){for(var s in t){if(Object.prototype.hasOwnProperty.call(t,s)){u(t[s],s,t)}}}else{for(var s=0,r=t.length;s<r;s++){u(t[s],s,t)}}};var n=function(r){return r.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")};var o=function(s,r){s=s.replace(/\s{1,}/mg," ");return s.trim()};var g=function(t){if(a(t)){return t}try{var r=JSON.parse(t);return r}catch(s){return{}}};var d=function(t){var s,r;s=document.createRange();s.selectNodeContents(t);s.collapse(false);r=window.getSelection();r.removeAllRanges();r.addRange(s);return};var p=function(r){return((r>47&&r<58)||(r>64&&r<91)||(r>95&&r<112)||(r>185&&r<193)||(r>218&&r<223))};var i=function(r){if(!Array.isArray(r)&&r instanceof HTMLElement){r=[r]}if(typeof jQuery!=="undefined"){k(r,function(s){jQuery(s).remove();if(s in l){delete l[s]}});return}k(r,function(s){if(s in l){k(l[s],function(u,t){k(t,function(w){try{s.removeEventListener(u,w,false)}catch(v){this.debug("failed to unregister events when removing object")}})});delete l[s]}s.parentNode.removeChild(s)})};var l={};var h=function(r,s,t){if(!r||typeof t!=="function"||!s){return false}if(!(r in l)){l[r]={}}if(!(s in l[r])){l[r][s]=[]}l[r][s].push(t);r.addEventListener(s,t,false)};var a=function(r){return(r!==null&&typeof r==="object"&&!Array.isArray(r))};var m={orderType:"",order:"ASC",placeholder:"---",placeholderOption:"---",search:false,watch:0};var c=function(r){this.element=r};c.prototype={_:this,container:null,selections:null,button:null,items:null,search:null,searchValue:null,hash:null,settings:{},watch:null,debounceQueue:{},updateLock:false,debug:function(r){if(!this.settings.debug){return false}console.log("blobSelect["+new Date().toISOString().slice(0,19).replace("T"," ")+"] "+r);return true},initialized:function(){return(this.container instanceof HTMLDivElement)},init:function(){if(this.initialized()){return this.debug("already initialized; aborting")}this.saveSettings(this.element.getAttribute("data-blobselect")||{});this.container=document.createElement("div");this.container.classList.add("blobselect");if(this.element.multiple){this.container.classList.add("is-multiple")}this.container.tabIndex=this.element.tabIndex||0;this.element.parentNode.insertBefore(this.container,this.element);this.debug("built container");this.selections=document.createElement("div");this.selections.classList.add("blobselect-selections");this.container.appendChild(this.selections);this.container.appendChild(this.element);this.button=document.createElement("div");this.button.classList.add("blobselect-button");this.container.appendChild(this.button);this.items=document.createElement("div");this.items.classList.add("blobselect-items");this.container.appendChild(this.items);this.searchField();this.updateBuild();var r=this;if(this.settings.watch){this.debug("watching for changes every "+(this.settings.watch/1000)+" seconds");this.watch=setInterval(function(){r.updateBuild(false)},this.settings.watch)}h(this.element,"change",function(){if(!r.updateLock){r.debug("element change event fired");r.updateBuild(false)}});h(j("html"),"click",function(s){r.debug("click outside");if(r.isOpen()){if(b(s.target,".blobselect")!==null){return true}else{r.close()}}});h(this.container,"click",function(s){return r.containerClick(s)});h(this.container,"keyup",function(s){return r.containerKey(s)});return true},saveSettings:function(r){r=g(r);if(!a(r)){r={}}this.settings=e(m,r);if(typeof this.settings.search!=="boolean"){this.settings.search=(typeof this.settings.search==="string"&&this.settings.search.toLowerCase()==="true")||(typeof this.settings.search==="numeric"&&this.settings.search)}this.settings.order=typeof this.settings.order==="string"&&["ASC","DESC"].indexOf(this.settings.order.toUpperCase())!==-1?this.settings.order.toUpperCase():false;this.settings.orderType=typeof this.settings.orderType==="string"&&["string","numeric"].indexOf(this.settings.orderType.toLowerCase())!==-1?this.settings.orderType.toLowerCase():false;this.settings.placeholder=o(this.settings.placeholder);this.settings.placeholderOption=o(this.settings.placeholderOption);this.settings.watch=parseInt(this.settings.watch,10)||0;if(this.settings.watch<0){this.settings.watch=0}if(typeof this.settings.debug!=="boolean"){this.settings.debug=(typeof this.settings.debug==="string"&&this.settings.debug.toLowerCase()==="true")||(typeof this.settings.debug==="numeric"&&this.settings.debug)}this.debug("using settings: "+JSON.stringify(this.settings));this.searchField()},searchField:function(){if(!this.initialized()){return false}if(!this.settings.search&&this.search!==null){i(this.search);this.search=null;this.debug("search field removed")}else{if(this.settings.search&&this.search===null){this.search=document.createElement("div");this.search.classList.add("blobselect-item-search");this.search.setAttribute("type","text");this.search.setAttribute("contentEditable","true");this.search.tabIndex=0;if(this.items.firstChild){this.items.insertBefore(this.search,this.items.firstChild)}else{this.items.appendChild(this.search)}this.debug("search field built")}}return true},debounce:function(r,s,t){if(t===undefined||t===null){t=250}if(this.debounceQueue[r]!==undefined&&this.debounceQueue[r]!==null){clearTimeout(this.debounceQueue[r])}this.debounceQueue[r]=setTimeout(s(),t);return true},updateBuild:function(s){var r=this;return this.debounce("updateBuild",function(){var t=r.getHash();r.debug("checking for updates");if(s||t!==r.hash){r.debug("updates found");r.hash=t;r.updateSelections();r.updateItems();r.searchValue=null;r.filterItems()}},100)},getHash:function(){if(!this.initialized()){return false}var r=[];k(q("option, optgroup",this.element),function(s){r.push({value:s.value,label:s.textContent,selected:s.selected,disabled:s.disabled})});return f(JSON.stringify(r))},updateItems:function(){if(!this.initialized()){return false}var s=[],u=this;optgroup=q("optgroup",this.element).length;if(optgroup){k(q("optgroup",this.element),function(w){s.push(w);var v=[];k(q("option",w),function(x){v.push(x)});v=u.sortItems(v);k(v,function(x){s.push(x)})});var r=[];k(this.element.children,function(v){if(v.tagName==="OPTION"){r.push(v)}});r=this.sortItems(r);k(r,function(v){s.push(v)})}else{k(q("option",this.element),function(v){s.push(v)});s=this.sortItems(s)}i(q(".blobselect-item-group, .blobselect-item",this.items));var t=1;k(s,function(x){var w=document.createElement("div");if(x.tagName==="OPTGROUP"){w.classList.add("blobselect-item-group");w.textContent=o(x.label)}else{t++;w.tabIndex=t;var v=o(x.textContent);w.classList.add("blobselect-item");if(x.selected){w.classList.add("is-active")}if(x.parentNode.tagName==="OPTGROUP"){w.classList.add("has-group")}if(x.disabled){w.classList.add("is-disabled")}w.setAttribute("data-value",x.value);w.setAttribute("data-label",v);if(!v.length||v.toLowerCase()===u.settings.placeholderOption.toLowerCase()){w.classList.add("is-placeholder");w.textContent=u.settings.placeholderOption}else{w.textContent=v}h(w,"focus",function(y){u.items.setAttribute("data-focused",q(".blobselect-item",u.items).indexOf(w));w.classList.add("is-focused")});h(w,"blur",function(y){w.classList.remove("is-focused")})}u.items.appendChild(w)});this.debug("dropdown items rebuilt")},getActiveItem:function(){var s,t=this,r=q(".blobselect-item",this.items),u=parseInt(this.items.getAttribute("data-focused"),10)||-1;if(u!==-1){s=r[u]}if(!s||s.classList.contains("is-disabled")||s.classList.contains("is-not-match")){s=null;k(r,function(v){if(!v.classList.contains("is-not-match")&&!v.classList.contains("is-disabled")){if(!s){t.debug('first item "'+v.getAttribute("data-value")+'"');s=v}}})}return s},updateSelections:function(){if(!this.initialized()){return false}var r=[],t=this;k(q("option",this.element),function(s){if(s.selected){r.push(s)}});r=this.sortItems(r);while(this.selections.firstChild){i(this.selections.firstChild)}k(r,function(v){var u=document.createElement("div"),s=o(v.textContent);u.classList.add("blobselect-selection");u.setAttribute("data-value",v.value);u.setAttribute("data-label",s);if(!s.length||s.toLowerCase()===t.settings.placeholderOption.toLowerCase()){u.classList.add("is-placeholder");u.textContent=t.settings.placeholder}else{u.textContent=s}t.selections.appendChild(u)});this.debug("selections rebuilt")},containerClick:function(r){r.stopPropagation();this.debug("clicked");if(r.target.classList.contains("blobselect-selection")&&this.element.multiple){return this.unselect(r.target)}else{if(r.target.classList.contains("blobselect-item-search")){this.search.setAttribute("contentEditable","true");return}else{if(r.target.classList.contains("blobselect-item")){if(!r.target.classList.contains("is-disabled")){this.select(r.target)}return}}}if(!this.isOpen()){return this.open()}else{return this.close()}},containerKey:function(w){var t=w.keyCode,v={8:"backspace",9:"tab",13:"enter",27:"escape",32:"space",37:"left",38:"up",39:"right",40:"down",},x=v[t]||"other",s=p(t);if(!this.isOpen()){if(["tab","backspace"].indexOf(x)===-1){w.stopPropagation();if(this.settings.search&&s){this.search.textContent=String.fromCharCode(t).toLowerCase();this.searchValue=null;this.filterItems()}return this.open()}return}else{if(x==="escape"){w.stopPropagation();return this.close()}else{if(x==="enter"){w.stopPropagation();w.preventDefault();if(this.search){this.search.innerHTML=o(this.search.textContent)}var r=this.getActiveItem();if(r){return this.select(r)}else{return this.close()}}else{if(["tab","up","down","left","right"].indexOf(x)!==-1){w.stopPropagation();if(w.target.classList.contains("blobselect-item-search")){if(["tab","up","down"].indexOf(x)!==-1){return this.traverseItems("current")}return}var u=["tab","down","right"].indexOf(x)!==-1?"next":"back";return this.traverseItems(u)}else{if(w.target.classList.contains("blobselect-item-search")){w.stopPropagation();if(o(this.search.textContent).toLowerCase()!==this.searchValue){this.searchValue=o(this.search.textContent).toLowerCase();return this.filterItems()}return}}}}}},traverseItems:function(v){var u=this.getActiveItem(),t=q(".blobselect-item:not(.is-disabled):not(.is-not-match)",this.items),r=t.indexOf(u),s=null;if(r===-1){if(t.length){r=0}else{return}}if(v==="current"){s=t[r]}else{if(v==="back"){s=r>0?t[r-1]:t[0]}else{s=r<t.length-1?t[r+1]:t[t.length-1]}}return s.focus()},isOpen:function(){return(this.container.classList.contains("is-open")||this.container.classList.contains("is-opening"))},open:function(){var r=this;if(!this.initialized()||this.isOpen()){return true}k(q(".blobselect.is-open select"),function(t){t.blobSelect.close()});this.items.setAttribute("data-focused",-1);this.container.classList.add("is-opening");setTimeout(function(){r.container.classList.add("is-open");r.container.classList.remove("is-opening")},50);if(r.settings.search){r.search.setAttribute("contentEditable","true");r.search.focus();d(r.search)}this.debug("dropdown opened")},close:function(){if(!this.initialized()||!this.isOpen()){return true}this.container.classList.remove("is-open","is-opening");this.container.focus();this.items.setAttribute("data-focused",-1);this.debug("dropdown closed")},triggerChange:function(){this.updateLock=true;var r=document.createEvent("UIEvents");r.initUIEvent("change",true,true,window,1);this.element.dispatchEvent(r);this.updateLock=false},select:function(u){if(!this.initialized()||!(u instanceof HTMLDivElement)||!u.classList.contains("blobselect-item")){return this.close()}var t=u.getAttribute("data-value")||"",r=this.getOptionByValue(t),s=this;if(r.length){if(this.element.multiple){k(r,function(v){if(v.selected){v.selected=0;s.debug('unselected: "'+v.value+'"')}else{v.selected=1;s.debug('selected: "'+v.value+'"')}})}else{this.element.selectedIndex=r[0].index;this.debug('selected: "'+r[0].value+'"')}}else{if(!this.element.multiple){this.element.selectedIndex=this.element.firstChild.index;this.debug('selected: "'+this.element.firstChild.value+'"')}}this.close();this.updateBuild();this.triggerChange()},unselect:function(u){if(!this.initialized()||!this.element.multiple||!(u instanceof HTMLDivElement)||!(u.classList.contains("blobselect-selection")||u.classList.contains("blobselect-item"))){return this.close()}var t=u.getAttribute("data-value")||"",r=this.getOptionByValue(t,true),s=this;if(r.length){k(r,function(v){v.selected=0;s.debug('unselected: "'+v.value+'"')})}this.close();this.updateBuild();this.triggerChange()},getOptionByValue:function(t,u){if(!this.initialized()){return false}var r=this,s=[];k(q("option",this.element),function(v){if(v.value===t&&(u||!v.disabled)){s.push(v)}});return s},filterItems:function(){if(!this.initialized()||!this.settings.search){return false}var r=this;this.debounce("filterItems",function(){var u=n(o(r.search.textContent)),s=q(".blobselect-item",r.items),t=0;if(u.length){k(s,function(w){var y=w.getAttribute("data-label"),x=!u.length||RegExp(u,"i").test(y),v=!w.classList.contains("is-not-match");if(w.classList.contains("is-placeholder")){y=r.settings.placeholderOption}w.textContent=y;if(x){w.classList.remove("is-not-match");w.classList.add("is-match");w.innerHTML=y.replace(RegExp(u,"gi"),"<mark>$&</mark>");t++}else{if(!x){w.classList.add("is-not-match");w.classList.remove("is-match")}}})}if(!t){k(s,function(v){v.classList.remove("is-not-match");v.innerHTML=v.textContent})}else{r.debug("items filtered by search term")}},100)},sortItems:function(r){if(!this.initialized()||!this.settings.orderType||!this.settings.order||!Array.isArray(r)||!r.length){return r}var s=this;r.sort(function(v,u){var w=v.getAttribute("data-label")||o(v.textContent)||o(v.label),t=u.getAttribute("data-label")||o(u.textContent)||o(u.label);if(s.settings.orderType==="numeric"){w=Number(w.replace(/[^\d\.]/g,""))||0,t=Number(t.replace(/[^\d\.]/g,""))||0}if(w===t){return 0}else{if(s.settings.order==="ASC"){return w<t?-1:1}else{return w>t?-1:1}}});return r}};Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:function(){Object.defineProperty(this,"blobSelect",{value:new c(this)});return this.blobSelect},configurable:true,writeable:false});document.addEventListener("DOMContentLoaded",function(){k(q("select[data-blobselect]"),function(r){r.blobSelect.init()})})})();
/**
*
* blobSelect
* version: 1.0
* home: https://blobfolio.com
*
* use:
*	<select data-blobselect="{OPTIONS}">
*	select fields with the data-blobselect attribute are auto-initialized on load
*	select fields can be manually initialized with:
*		document.getElementById('myselect').blobSelect.init()
*
* options:
*	orderType (string, numeric, null)
*		(string)
*		options will be resorted based on their values
*		default: null (i.e. no sort)
*	order (ASC, DESC)
*		(string)
*		options will be resorted up or down
*		default: ASC
*	placeholder (string)
*		mimics an input's placeholder attribute; this text is displayed when the
*		selection has no label
*		default: ---
*	placeholderOption (string)
*		this text is used when an option has no label
*		default: ---
*	search (bool)
*		a contentEditable field is placed at the top of the menu
*		to allow users to filter results
*		default: false
*	watch (int)
*		have each blobSelect instance watch itself for unannounced changes
*		(that is, no proper event was fired) every WATCH milliseconds
*		this adds overhead, but can be necessary with e.g. AngularJS
*		default: false
*	debug (bool)
*		dump lots of event info to the console log
*		default: false
*
**/
(function(){if(!("classList" in document.documentElement)||!("createRange" in document)||!("querySelector" in document&&"querySelectorAll" in document)||!("JSON" in window&&"parse" in JSON&&"stringify" in JSON)){console.warn("blobSelect["+new Date().toISOString().slice(0,19).replace("T"," ")+"] aborted; browser missing feature support");return}if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(u){var v=(this.document||this.ownerDocument).querySelectorAll(u),t=v.length;while(--t>=0&&v.item(t)!==this){}return t>-1}}function p(B,x){var C,D,z,t,w,s,u,A,y,v;C=B.length&3;D=B.length-C;z=x;w=3432918353;u=461845907;v=0;while(v<D){y=((B.charCodeAt(v)&255))|((B.charCodeAt(++v)&255)<<8)|((B.charCodeAt(++v)&255)<<16)|((B.charCodeAt(++v)&255)<<24);++v;y=((((y&65535)*w)+((((y>>>16)*w)&65535)<<16)))&4294967295;y=(y<<15)|(y>>>17);y=((((y&65535)*u)+((((y>>>16)*u)&65535)<<16)))&4294967295;z^=y;z=(z<<13)|(z>>>19);t=((((z&65535)*5)+((((z>>>16)*5)&65535)<<16)))&4294967295;z=(((t&65535)+27492)+((((t>>>16)+58964)&65535)<<16))}y=0;switch(C){case 3:y^=(B.charCodeAt(v+2)&255)<<16;case 2:y^=(B.charCodeAt(v+1)&255)<<8;case 1:y^=(B.charCodeAt(v)&255);y=(((y&65535)*w)+((((y>>>16)*w)&65535)<<16))&4294967295;y=(y<<15)|(y>>>17);y=(((y&65535)*u)+((((y>>>16)*u)&65535)<<16))&4294967295;z^=y}z^=B.length;z^=z>>>16;z=(((z&65535)*2246822507)+((((z>>>16)*2246822507)&65535)<<16))&4294967295;z^=z>>>13;z=((((z&65535)*3266489909)+((((z>>>16)*3266489909)&65535)<<16)))&4294967295;z^=z>>>16;return z>>>0}var b=function(t,s){if(!t){return null}return typeof t==="string"?(s||document).querySelector(t):t};var j=function(t,s){return Array.prototype.slice.call((s||document).querySelectorAll(t))};var c=function(t,u){var s={};e(t,function(w,v){s[v]=t[v]});e(u,function(w,v){s[v]=u[v]});return s};var r=function(t,s){try{if(t.matches(s)){return t}while(t.parentNode&&"matches" in t.parentNode){t=t.parentNode;if(t.matches(s)){return t}}}catch(u){}return null};var e=function(u,v){if(Object.prototype.toString.call(u)==="[object Object]"){for(var t in u){if(Object.prototype.hasOwnProperty.call(u,t)){v(u[t],t,u)}}}else{for(var t=0,s=u.length;t<s;t++){v(u[t],t,u)}}};var h=function(t){return t.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")};var q=function(t,s){t=t.replace(/\s{1,}/mg," ");return t.trim()};var i=function(u){if(o(u)){return u}try{var s=JSON.parse(u);return s}catch(t){return{}}};var f=function(u){var t,s;t=document.createRange();t.selectNodeContents(u);t.collapse(false);s=window.getSelection();s.removeAllRanges();s.addRange(t);return};var l=function(s){return((s>47&&s<58)||(s>64&&s<91)||(s>95&&s<112)||(s>185&&s<193)||(s>218&&s<223))};var k=function(s){if(!Array.isArray(s)&&s instanceof HTMLElement){s=[s]}if(typeof jQuery!=="undefined"){e(s,function(t){jQuery(t).remove();if(t in m){delete m[t]}});return}e(s,function(t){if(t in m){e(m[t],function(v,u){e(u,function(x){try{t.removeEventListener(v,x,false)}catch(w){this.debug("failed to unregister events when removing object")}})});delete m[t]}t.parentNode.removeChild(t)})};var m={};var n=function(s,t,u){if(!s||typeof u!=="function"||!t){return false}if(!(s in m)){m[s]={}}if(!(t in m[s])){m[s][t]=[]}m[s][t].push(u);s.addEventListener(t,u,false)};var o=function(s){return(s!==null&&typeof s==="object"&&!Array.isArray(s))};var a={orderType:"",order:"ASC",placeholder:"---",placeholderOption:"---",search:false,watch:0};var d=function(s){this.element=s};d.prototype={_:this,container:null,selections:null,button:null,items:null,search:null,searchValue:null,hash:null,settings:{},watch:null,debounceQueue:{},updateLock:false,debug:function(s){if(!this.settings.debug){return false}console.log("blobSelect["+new Date().toISOString().slice(0,19).replace("T"," ")+"] "+s);return true},initialized:function(){return(this.container instanceof HTMLDivElement)},init:function(){if(this.initialized()){return this.debug("already initialized; aborting")}this.saveSettings(this.element.getAttribute("data-blobselect")||{});this.container=document.createElement("div");this.container.classList.add("blobselect");if(this.element.multiple){this.container.classList.add("is-multiple")}this.container.tabIndex=this.element.tabIndex||0;this.element.parentNode.insertBefore(this.container,this.element);this.debug("built container");this.selections=document.createElement("div");this.selections.classList.add("blobselect-selections");this.container.appendChild(this.selections);this.container.appendChild(this.element);this.button=document.createElement("div");this.button.classList.add("blobselect-button");this.container.appendChild(this.button);this.items=document.createElement("div");this.items.classList.add("blobselect-items");this.container.appendChild(this.items);this.searchField();this.updateBuild();var s=this;if(this.settings.watch){this.debug("watching for changes every "+(this.settings.watch/1000)+" seconds");this.watch=setInterval(function(){s.updateBuild(false)},this.settings.watch)}n(this.element,"change",function(){if(!s.updateLock){s.debug("element change event fired");s.updateBuild(false)}});n(b("html"),"click",function(t){s.debug("click outside");if(s.isOpen()){if(r(t.target,".blobselect")!==null){return true}else{s.close()}}});n(this.container,"click",function(t){return s.containerClick(t)});n(this.container,"keyup",function(t){return s.containerKey(t)});return true},saveSettings:function(s){s=i(s);if(!o(s)){s={}}this.settings=c(a,s);if(typeof this.settings.search!=="boolean"){this.settings.search=(typeof this.settings.search==="string"&&this.settings.search.toLowerCase()==="true")||(typeof this.settings.search==="numeric"&&this.settings.search)}this.settings.order=typeof this.settings.order==="string"&&["ASC","DESC"].indexOf(this.settings.order.toUpperCase())!==-1?this.settings.order.toUpperCase():false;this.settings.orderType=typeof this.settings.orderType==="string"&&["string","numeric"].indexOf(this.settings.orderType.toLowerCase())!==-1?this.settings.orderType.toLowerCase():false;this.settings.placeholder=q(this.settings.placeholder);this.settings.placeholderOption=q(this.settings.placeholderOption);this.settings.watch=parseInt(this.settings.watch,10)||0;if(this.settings.watch<0){this.settings.watch=0}if(typeof this.settings.debug!=="boolean"){this.settings.debug=(typeof this.settings.debug==="string"&&this.settings.debug.toLowerCase()==="true")||(typeof this.settings.debug==="numeric"&&this.settings.debug)}this.debug("using settings: "+JSON.stringify(this.settings));this.searchField()},searchField:function(){if(!this.initialized()){return false}if(!this.settings.search&&this.search!==null){k(this.search);this.search=null;this.debug("search field removed")}else{if(this.settings.search&&this.search===null){this.search=document.createElement("div");this.search.classList.add("blobselect-item-search");this.search.setAttribute("type","text");this.search.setAttribute("contentEditable","true");this.search.tabIndex=0;if(this.items.firstChild){this.items.insertBefore(this.search,this.items.firstChild)}else{this.items.appendChild(this.search)}this.debug("search field built")}}return true},debounce:function(s,t,u){if(u===undefined||u===null){u=250}if(this.debounceQueue[s]!==undefined&&this.debounceQueue[s]!==null){clearTimeout(this.debounceQueue[s])}this.debounceQueue[s]=setTimeout(t(),u);return true},updateBuild:function(t){var s=this;return this.debounce("updateBuild",function(){var u=s.getHash();s.debug("checking for updates");if(t||u!==s.hash){s.debug("updates found");s.hash=u;s.updateSelections();s.updateItems();s.searchValue=null;s.filterItems()}},100)},getHash:function(){if(!this.initialized()){return false}var s=[];e(j("option, optgroup",this.element),function(t){s.push({value:t.value,label:t.textContent,selected:t.selected,disabled:t.disabled})});return p(JSON.stringify(s))},updateItems:function(){if(!this.initialized()){return false}var t=[],v=this;optgroup=j("optgroup",this.element).length;if(optgroup){e(j("optgroup",this.element),function(x){t.push(x);var w=[];e(j("option",x),function(y){w.push(y)});w=v.sortItems(w);e(w,function(y){t.push(y)})});var s=[];e(this.element.children,function(x){if(x.tagName==="OPTION"){var w=q(x.textContent);if(!w.length||w.toLowerCase()===v.settings.placeholderOption.toLowerCase()){t.unshift(x)}else{s.push(x)}}});s=this.sortItems(s);e(s,function(w){t.push(w)})}else{e(j("option",this.element),function(w){t.push(w)});t=this.sortItems(t)}k(j(".blobselect-item-group, .blobselect-item",this.items));var u=1;e(t,function(y){var x=document.createElement("div");if(y.tagName==="OPTGROUP"){x.classList.add("blobselect-item-group");x.textContent=q(y.label)}else{u++;x.tabIndex=u;var w=q(y.textContent);x.classList.add("blobselect-item");if(y.selected){x.classList.add("is-active")}if(y.parentNode.tagName==="OPTGROUP"){x.classList.add("has-group")}if(y.disabled){x.classList.add("is-disabled")}x.setAttribute("data-value",y.value);x.setAttribute("data-label",w);if(!w.length||w.toLowerCase()===v.settings.placeholderOption.toLowerCase()){x.classList.add("is-placeholder");x.textContent=v.settings.placeholderOption}else{x.textContent=w}n(x,"focus",function(z){v.items.setAttribute("data-focused",j(".blobselect-item",v.items).indexOf(x));x.classList.add("is-focused")});n(x,"blur",function(z){x.classList.remove("is-focused")})}v.items.appendChild(x)});this.debug("dropdown items rebuilt")},getActiveItem:function(){var t,u=this,s=j(".blobselect-item",this.items),v=parseInt(this.items.getAttribute("data-focused"),10)||-1;if(v!==-1){t=s[v]}if(!t||t.classList.contains("is-disabled")||t.classList.contains("is-not-match")){t=null;e(s,function(w){if(!w.classList.contains("is-not-match")&&!w.classList.contains("is-disabled")){if(!t){u.debug('first item "'+w.getAttribute("data-value")+'"');t=w}}})}return t},updateSelections:function(){if(!this.initialized()){return false}var t=[],u=this;e(j("option",this.element),function(s){if(s.selected){t.push(s)}});t=this.sortItems(t);while(this.selections.firstChild){k(this.selections.firstChild)}e(t,function(w){var v=document.createElement("div"),s=q(w.textContent);v.classList.add("blobselect-selection");v.setAttribute("data-value",w.value);v.setAttribute("data-label",s);if(!s.length||s.toLowerCase()===u.settings.placeholderOption.toLowerCase()){v.classList.add("is-placeholder");v.textContent=u.settings.placeholder}else{v.textContent=s}u.selections.appendChild(v)});this.debug("selections rebuilt")},containerClick:function(s){s.stopPropagation();this.debug("clicked");if(s.target.classList.contains("blobselect-selection")&&this.element.multiple){return this.unselect(s.target)}else{if(s.target===this.element){return}else{if(s.target.classList.contains("blobselect-item-search")){this.search.setAttribute("contentEditable","true");return}else{if(s.target.classList.contains("blobselect-item")){if(!s.target.classList.contains("is-disabled")){this.select(s.target)}return}}}}if(!this.isOpen()){return this.open()}else{return this.close()}},containerKey:function(x){var u=x.keyCode,w={8:"backspace",9:"tab",13:"enter",27:"escape",32:"space",37:"left",38:"up",39:"right",40:"down",},y=w[u]||"other",t=l(u);if(!this.isOpen()){if(["tab","backspace"].indexOf(y)===-1){x.stopPropagation();if(this.settings.search&&t){this.search.textContent=String.fromCharCode(u).toLowerCase();this.searchValue=null;this.filterItems()}return this.open()}return}else{if(y==="escape"){x.stopPropagation();return this.close()}else{if(y==="enter"){x.stopPropagation();x.preventDefault();if(this.search){this.search.innerHTML=q(this.search.textContent)}var s=this.getActiveItem();if(s){return this.select(s)}else{return this.close()}}else{if(["tab","up","down","left","right"].indexOf(y)!==-1){x.stopPropagation();if(x.target.classList.contains("blobselect-item-search")){if(["tab","up","down"].indexOf(y)!==-1){return this.traverseItems("current")}return}var v=["tab","down","right"].indexOf(y)!==-1?"next":"back";return this.traverseItems(v)}else{if(x.target.classList.contains("blobselect-item-search")){x.stopPropagation();if(q(this.search.textContent).toLowerCase()!==this.searchValue){this.searchValue=q(this.search.textContent).toLowerCase();return this.filterItems()}return}}}}}},traverseItems:function(w){var v=this.getActiveItem(),u=j(".blobselect-item:not(.is-disabled):not(.is-not-match)",this.items),s=u.indexOf(v),t=null;if(s===-1){if(u.length){s=0}else{return}}if(w==="current"){t=u[s]}else{if(w==="back"){t=s>0?u[s-1]:u[0]}else{t=s<u.length-1?u[s+1]:u[u.length-1]}}return t.focus()},isOpen:function(){return(this.container.classList.contains("is-open")||this.container.classList.contains("is-opening"))},open:function(){var s=this;if(!this.initialized()||this.isOpen()){return true}e(j(".blobselect.is-open select"),function(t){t.blobSelect.close()});this.items.setAttribute("data-focused",-1);this.container.classList.add("is-opening");setTimeout(function(){s.container.classList.add("is-open");s.container.classList.remove("is-opening")},50);if(s.settings.search){s.search.setAttribute("contentEditable","true");s.search.focus();f(s.search)}this.debug("dropdown opened")},close:function(){if(!this.initialized()||!this.isOpen()){return true}this.container.classList.remove("is-open","is-opening");this.container.focus();this.items.setAttribute("data-focused",-1);this.debug("dropdown closed")},triggerChange:function(){this.updateLock=true;var s=document.createEvent("UIEvents");s.initUIEvent("change",true,true,window,1);this.element.dispatchEvent(s);this.updateLock=false},select:function(v){if(!this.initialized()||!(v instanceof HTMLDivElement)||!v.classList.contains("blobselect-item")){return this.close()}var u=v.getAttribute("data-value")||"",s=this.getOptionByValue(u),t=this;if(s.length){if(this.element.multiple){e(s,function(w){if(w.selected){w.selected=0;t.debug('unselected: "'+w.value+'"')}else{w.selected=1;t.debug('selected: "'+w.value+'"')}})}else{this.element.selectedIndex=s[0].index;this.debug('selected: "'+s[0].value+'"')}}else{if(!this.element.multiple){this.element.selectedIndex=this.element.firstChild.index;this.debug('selected: "'+this.element.firstChild.value+'"')}}this.close();this.updateBuild();this.triggerChange()},unselect:function(v){if(!this.initialized()||!this.element.multiple||!(v instanceof HTMLDivElement)||!(v.classList.contains("blobselect-selection")||v.classList.contains("blobselect-item"))){return this.close()}var u=v.getAttribute("data-value")||"",s=this.getOptionByValue(u,true),t=this;if(s.length){e(s,function(w){w.selected=0;t.debug('unselected: "'+w.value+'"')})}this.close();this.updateBuild();this.triggerChange()},getOptionByValue:function(u,v){if(!this.initialized()){return false}var s=this,t=[];e(j("option",this.element),function(w){if(w.value===u&&(v||!w.disabled)){t.push(w)}});return t},filterItems:function(){if(!this.initialized()||!this.settings.search){return false}var s=this;this.debounce("filterItems",function(){var v=h(q(s.search.textContent)),t=j(".blobselect-item",s.items),u=0;if(v.length){e(t,function(x){var z=x.getAttribute("data-label"),y=!v.length||RegExp(v,"i").test(z),w=!x.classList.contains("is-not-match");if(x.classList.contains("is-placeholder")){z=s.settings.placeholderOption}x.textContent=z;if(y){x.classList.remove("is-not-match");x.classList.add("is-match");x.innerHTML=z.replace(RegExp(v,"gi"),"<mark>$&</mark>");u++}else{if(!y){x.classList.add("is-not-match");x.classList.remove("is-match")}}})}if(!u){e(t,function(w){w.classList.remove("is-not-match");w.innerHTML=w.textContent})}else{s.debug("items filtered by search term")}},100)},sortItems:function(s){if(!this.initialized()||!this.settings.orderType||!this.settings.order||!Array.isArray(s)||!s.length){return s}var t=this;s.sort(function(w,v){var x=w.getAttribute("data-label")||q(w.textContent)||q(w.label),u=v.getAttribute("data-label")||q(v.textContent)||q(v.label);if(x.toLowerCase()===t.settings.placeholderOption.toLowerCase()){x=t.settings.orderType==="numeric"?0:""}if(u.toLowerCase()===t.settings.placeholderOption.toLowerCase()){u=t.settings.orderType==="numeric"?0:""}if(t.settings.orderType==="numeric"){x=Number(x.replace(/[^\d\.]/g,""))||0,u=Number(u.replace(/[^\d\.]/g,""))||0}if(x===u){return 0}else{if(t.settings.order==="ASC"){return x<u?-1:1}else{return x>u?-1:1}}});return s}};Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:function g(){Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:undefined});Object.defineProperty(this,"blobSelect",{value:new d(this)});Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:g});return this["blobSelect"]},configurable:true});document.addEventListener("DOMContentLoaded",function(){e(j("select[data-blobselect]"),function(s){s.blobSelect.init()})})})();
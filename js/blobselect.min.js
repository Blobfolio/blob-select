/**
*
* blobSelect
* version: 0.7
* home: https://blobfolio.com
*
* use:
*	<select data-blobselect="{OPTIONS}">
*	select fields with the data-blobselect attribute are auto-initialized on load
*	select fields can be manually initialized with:
*		new blobSelect(getElementById('the-field'))
*
* options:
*	orderType (string, numeric, null)
*		(string)
*		options will be resorted based on their values
*		default: null (i.e. no sort)
*	order (ASC, DESC)
*		(string)
*		options will be resorted up or down
*		default: ASC
*	placeholder (string)
*		mimics an input's placeholder attribute; this text is displayed when the
*		selection has no label
*		default: ---
*	placeholderOption (string)
*		this text is used when an option has no label
*		default: ---
*	search (bool)
*		a contentEditable field is placed at the top of the menu
*		to allow users to filter results
*		default: false
*
**/
(function(){function $(expr,con){if(!expr)return null;return typeof expr==='string'?(con||document).querySelector(expr):expr;}
function $$(expr,con){return Array.prototype.slice.call((con||document).querySelectorAll(expr));}
function _hasSupport(){try{document.querySelectorAll('select');if(typeof JSON!=='object'||typeof JSON.parse!=='function')
return false;return true;}catch(e){return false;}}
function _extend(defaults,overrides){var extended={};_forEach(defaults,function(value,key){extended[key]=defaults[key];});_forEach(overrides,function(value,key){extended[key]=overrides[key];});return extended;}
function _forEach(collection,callback){if(Object.prototype.toString.call(collection)==='[object Object]')
{for(var key in collection)
{if(Object.prototype.hasOwnProperty.call(collection,key))
callback(collection[key],key,collection);}}
else
{for(var key=0,len=collection.length;key<len;key++)
callback(collection[key],key,collection);}}
function _sanitizeRegexp(s){return s.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&");}
function _parseJSON(str){try{var j=JSON.parse(str);return j;}
catch(e){return{};}}
function _removeElement(elements){_forEach(elements,function(element){element.parentNode.removeChild(element);});}
function _bind(element,event,callback){if(!element||typeof callback!=='function'||!event)
return false;element.addEventListener(event,callback,false);}
function _getClasses(element){var classString=element.getAttribute('class');if(classString===null)
classString='';classString=classString.replace('/\s{1,}/g',' ').trim();if(classString.indexOf(' ')!==-1)
return classString.split(' ');else if(classString.length)
{var arr=[];arr.push(classString);return arr;}
else
return[];}
function _hasClass(element,c){var classes=_getClasses(element);return classes.indexOf(c)!==-1;}
function _addClass(element,c){if(!_hasClass(element,c))
{var classes=_getClasses(element);classes.push(c);element.setAttribute('class',classes.join(' '));}
return true;}
function _removeClass(element,c){var classes=_getClasses(element),index=classes.indexOf(c);if(index!==-1)
{classes.splice(index,1);element.setAttribute('class',classes.join(' '));}
return true;}
var defaultSettings={"orderType":"","order":"ASC","placeholder":"---","placeholderOption":"---","search":false};var _=self.blobSelect=function(element){var b=this,id=b.getId(element);if(blobSelected[id]!==undefined)
return blobSelected[id];else
blobSelected[id]=this;if(!(typeof HTMLElement==="object"?element instanceof HTMLElement:element&&typeof element==="object"&&element!==null&&element.nodeType===1&&typeof element.nodeName==="string")&&element.tagName!=='SELECT')
return false;b.element=element;b.status=parseInt(b.element.getAttribute('data-blobselected'),10)||0;if(isNaN(b.status))
b.status=0;b.settings=_extend(defaultSettings,_parseJSON(b.element.getAttribute('data-blobselect')));if(b.settings.search==='true')
b.settings.search=true;b.options={};b.selections=[];b.multiple=(b.element.getAttribute('multiple')===null)?false:true;b.events=[];b.updateLock=false;b.previous=[];if(!b.element.getAttribute('data-tabindex'))
b.element.setAttribute('data-tabindex',b.element.tabIndex||0);if(b.settings.order&&['ASC','DESC'].indexOf(b.settings.order.toUpperCase())!==-1&&b.settings.orderType&&['string','numeric'].indexOf(b.settings.orderType.toLowerCase())!==-1)
b.sortOptions();b.build();}
_.prototype={getId:function(el){var b=this,id=el.getAttribute('data-blobselect-id')||false;if(!id)
{id=(((1+Math.random())*0x10000)|0).toString(16).substring(1).toUpperCase()+(((1+Math.random())*0x10000)|0).toString(16).substring(1).toUpperCase()+(((1+Math.random())*0x10000)|0).toString(16).substring(1).toUpperCase()+(((1+Math.random())*0x10000)|0).toString(16).substring(1).toUpperCase();el.setAttribute('data-blobselect-id',id);}
return id;},build:function(){var b=this;if(b.status)
b.destroy();var container=document.createElement('div');_addClass(container,'blobselect');if(b.multiple)
_addClass(container,'is-multiple');var ti=parseInt(b.element.getAttribute('data-tabindex'),10)||0;container.tabIndex=ti;b.element.parentNode.insertBefore(container,b.element);var selections=document.createElement('div');selections.setAttribute('class','blobselect-selections');container.appendChild(selections);container.appendChild(b.element);var button=document.createElement('div');_addClass(button,'blobselect-button');container.appendChild(button);var list=document.createElement('div');list.setAttribute('class','blobselect-items');container.appendChild(list);if(b.settings.search===true)
{var searchField=document.createElement('div');_addClass(searchField,'blobselect-item-search');searchField.setAttribute('type','text');searchField.setAttribute('contentEditable','true');list.appendChild(searchField);}
b.options={};_forEach($$('optgroup, option',b.element),function(option){var classes=[];if(option.tagName==='OPTGROUP')
classes.push('blobselect-item-group');else
{classes.push('blobselect-item');if(option.selected)
classes.push('is-active');if(option.parentNode.tagName==='OPTGROUP')
classes.push('has-group');if(option.textContent.trim().length&&option.textContent.trim().toLowerCase()!==b.settings.placeholder.toLowerCase())
b.options[option.value]=option.textContent;else
{b.options[option.value]=b.settings.placeholder;classes.push('is-placeholder');}}
var item=document.createElement('div');item.setAttribute('class',classes.join(' '));if(option.tagName==='OPTGROUP')
item.textContent=option.label;else
{item.setAttribute('tabIndex',1);item.setAttribute('data-value',option.value);item.textContent=option.textContent;if(!item.textContent.trim().length)
item.textContent=b.settings.placeholderOption;}
list.appendChild(item);});b.updateSelections();_bind(b.element,'change',function(){b.updateSelections();});_bind(b.element,'click',function(){b.updateSelections();});_bind(document.querySelector('html'),'click',function(e){if(_hasClass(b.element.parentNode,'is-open'))
{if(_hasClass(e.target.parentNode,'blobselect')||_hasClass(e.target,'blobselect')||/blobselect/.test(e.target.className))
return true;else
b.close();}});_forEach($$('.blobselect-item',b.element.parentNode),function(option){_bind(option,'click',function(e){e.stopPropagation();var value=option.getAttribute('data-value');if(b.selections.indexOf(value)!==-1)
{if(b.multiple)
b.removeSelection(value);}
else
b.addSelection(value);b.close();});_bind(option,'keyup',function(e){e.stopPropagation();var key=e.keyCode;if(key===13||key===32)
return option.click();});});_bind(container,'click',function(e){e.preventDefault();if(!_hasClass(this,'is-open'))
b.open();else
b.close();});_bind(container,'keyup',function(e){var key=e.keyCode;if(!_hasClass(this,'is-open')&&(key===13||key===32))
return b.open();else if(_hasClass(this,'is-open')&&key===27)
return b.close();});if(b.settings.search)
{_bind(searchField,'keyup',function(e){e.stopPropagation();var key=e.keyCode,textTest=_sanitizeRegexp(searchField.textContent.trim()),options=$$('.blobselect-item',searchField.parentNode.parentNode),matches=0;_forEach(options,function(option){var textOption=option.textContent.trim(),matchNew=!textTest.length||RegExp(textTest,"i").test(textOption),matchOld=!_hasClass(option,'is-not-match');option.textContent=textOption;if(matchNew&&!matchOld)
_removeClass(option,'is-not-match');else if(!matchNew&&matchOld)
_addClass(option,'is-not-match');if(_hasClass(option,'is-not-match')&&_hasClass(option,'is-match'))
_removeClass(option,'is-match');else if(!_hasClass(option,'is-not-match')&&!_hasClass(option,'is-match'))
_addClass(option,'is-match');if(matchNew)
option.innerHTML=textOption.replace(RegExp(textTest,"gi"),"<mark>$&</mark>");if(matchNew)
matches++;});if(!matches)
{_forEach($$('.is-not-match',searchField.parentNode.parentNode),function(option){_removeClass(option,'is-not-match');});}
if(key===13)
{var first=$('.blobselect-item.is-match',searchField.parentNode.parentNode);if(first!==null)
first.click();else
b.close();}
else if(key===27)
b.close();});_bind(searchField,'click',function(e){e.stopPropagation();});}
b.status=1;b.element.setAttribute('data-blobselected',1);},destroy:function(){var b=this;var container=b.element.parentNode;container.parentNode.insertBefore(b.element,container);_removeElement($$('.blobselect',container.parentNode));b.element.setAttribute('data-blobselected',0);},uncreate:function(){var b=this,id=b.getId();b.destroy();b.removeAttribute('data-blobselected');b.removeAttribute('data-blobselect-id');delete blobSelected[id];return true;},open:function(){var b=this,container=this.element.parentNode;if(_hasClass(container,'is-opening')||_hasClass(container,'is-open'))
return true;_forEach($$('.blobselect.is-open'),function(select){_removeClass(select,'is-open');});_addClass(container,'is-opening');setTimeout(function(){_addClass(container,'is-open');_removeClass(container,'is-opening');if(b.settings.search===true)
{setTimeout(function(){$('.blobselect-item-search',b.element.parentNode).textContent=$('.blobselect-item-search',b.element.parentNode).textContent.replace('/\s/g',' ').trim();$('.blobselect-item-search',b.element.parentNode).focus();},100);}},50);},close:function(container){var container=this.element.parentNode;_removeClass(container,'is-open');container.focus();},updateSelections:function(){var b=this;if(b.updateLock)
return;b.updateLock=true;if(!_hasClass(b.element.parentNode,'blobselect'))
return;b.selections=[];_forEach($$('option',b.element),function(option){if(option.selected)
b.selections.push(option.value);});var s=$('.blobselect-selections',b.element.parentNode);while(s.firstChild)
s.removeChild(s.firstChild);_forEach(b.selections,function(selection){var s=document.createElement('div');s.setAttribute('class','blobselect-selection');s.setAttribute('data-value',selection);if(!selection.trim().length||selection.trim().toLowerCase()===b.settings.placeholder.toLowerCase())
_addClass(s,'is-placeholder');s.textContent=b.options[selection];if(b.multiple)
{_bind(s,'click',function(e){e.stopPropagation();b.removeSelection(s.getAttribute('data-value'));});}
$('.blobselect-selections',b.element.parentNode).appendChild(s);});_forEach($$('.blobselect-item',b.element.parentNode),function(element){var selected_now=b.selections.indexOf(element.getAttribute('data-value'))!==-1,selected_then=_hasClass(element,'is-active');if(selected_now&&!selected_then)
_addClass(element,'is-active');else if(!selected_now&&selected_then)
_removeClass(element,'is-active');});if(JSON.stringify(b.previous)!==JSON.stringify(b.selections))
{var event=document.createEvent("UIEvents");event.initUIEvent("change",true,true,window,1);b.element.dispatchEvent(event);b.previous=b.selections;}
b.updateLock=false;},removeSelection:function(value){var b=this
option=b.getOptionByValue(value);if(option!==false)
{option.selected=0;b.updateSelections();return true;}
return false;},addSelection:function(value){var b=this,option=b.getOptionByValue(value),selected=b.element.selectedIndex;if(option!==false)
{if(b.multiple)
option.selected=1;else
b.element.selectedIndex=option.index;b.updateSelections();return true;}
return false;},getOptionByValue:function(value){var b=this,option=false;_forEach($$('option',b.element),function(element){if(element.value===value)
option=element;});return option;},sortOptions:function(){var options=$$('option',this.element);if(this.settings.orderType.toLowerCase()==='string')
options.sort(this.sortByString);else if(this.settings.orderType.toLowerCase()==='numeric')
options.sort(this.sortByNumber);if(this.settings.order.toUpperCase()==='DESC')
options.reverse();_forEach(options,function(option){option.parentNode.appendChild(option);});},sortByString:function(a,b){return a.textContent.trim().toLowerCase().localeCompare(b.textContent.trim().toLowerCase());},sortByNumber:function(a,b){var av=Number(a.textContent.replace(/[^\d\.]/g,'')),bv=Number(b.textContent.replace(/[^\d\.]/g,''));if(isNaN(av))
av=0;if(isNaN(bv))
bv=0;return av-bv;}}
function init(){_forEach($$('select[data-blobselect]'),function(select){new blobSelect(select);});}
try{document.addEventListener("DOMContentLoaded",init);}catch(e){}})();var blobSelected={};function getBlobSelectByElement(element,create=true){if(Array.isArray(element))
{for(var key=0,len=element.length;key<len;key++)
return getBlobSelectByElement(element[key]);}
if((typeof HTMLElement==="object"?element instanceof HTMLElement:element&&typeof element==="object"&&element!==null&&element.nodeType===1&&typeof element.nodeName==="string")&&element.tagName==='SELECT')
{var id=element.getAttribute('data-blobselect-id')||false;if(id&&blobSelected.hasOwnProperty(id))
return blobSelected[id];else if(create)
return new blobSelect(element);}
return false;}
!function(){function _hash(key,seed){var remainder,bytes,h1,h1b,c1,c2,k1,i;for("object"==typeof key&&(key=JSON.stringify(key)),remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;i<bytes;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,h1=27492+(65535&(h1b=5*(65535&(h1=(h1^=k1=(65535&(k1=(k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295)<<15|k1>>>17))*c2+(((k1>>>16)*c2&65535)<<16)&4294967295)<<13|h1>>>19))+((5*(h1>>>16)&65535)<<16)&4294967295))+((58964+(h1b>>>16)&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;break;case 2:k1^=(255&key.charCodeAt(i+1))<<8;break;case 1:h1^=k1=(65535&(k1=(k1=(65535&(k1^=255&key.charCodeAt(i)))*c1+(((k1>>>16)*c1&65535)<<16)&4294967295)<<15|k1>>>17))*c2+(((k1>>>16)*c2&65535)<<16)&4294967295}return h1^=key.length,h1^=h1>>>16,h1=2246822507*(65535&h1)+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>13,h1=3266489909*(65535&h1)+((3266489909*(h1>>>16)&65535)<<16)&4294967295,(h1^=h1>>>16)>>>0}if("classList"in document.documentElement&&"createRange"in document&&"querySelector"in document&&"querySelectorAll"in document&&"JSON"in window&&"parse"in JSON&&"stringify"in JSON){Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(s){for(var matches=(this.document||this.ownerDocument).querySelectorAll(s),i=matches.length;--i>=0&&matches.item(i)!==this;);return i>-1});var selectors=[":disabled",":required",":valid",":invalid"],$=function(expr,con){return expr?"string"==typeof expr?(con||document).querySelector(expr):expr:null},$$=function(expr,con){return Array.prototype.slice.call((con||document).querySelectorAll(expr))},_extend=function(defaults,overrides){var keys,keysLength,extended={};for("object"!=typeof defaults&&(defaults={}),"object"!=typeof overrides&&(overrides={}),keysLength=(keys=Object.keys(defaults)).length,i=0;i<keysLength;i++)extended[keys[i]]=defaults[keys[i]];for(keysLength=(keys=Object.keys(overrides)).length,i=0;i<keysLength;i++)void 0!==extended[keys[i]]&&void 0!==overrides[keys[i]]&&null!==overrides[keys[i]]&&(extended[keys[i]]=overrides[keys[i]]);return extended},_closest=function(el,selector){try{if(el.matches(selector))return el;for(;el.parentNode&&"matches"in el.parentNode;)if((el=el.parentNode).matches(selector))return el}catch(Ex){}return null},_forEach=function(collection,callback){if("[object Object]"===Object.prototype.toString.call(collection))for(var key in collection)Object.prototype.hasOwnProperty.call(collection,key)&&callback(collection[key],key,collection);else for(var akey=0,len=collection.length;akey<len;akey++)callback(collection[akey],akey,collection)},_sanitizeRegexp=function(s){return s.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")},_sanitizeWhitespace=function(str,trim){return(str=str.replace(/\s{1,}/gm," ")).trim()},_parseJSON=function(str){if(_isObject(str))return str;try{return JSON.parse(str)}catch(e){return{}}},_cursorToEnd=function(el){var searchRange,searchSelection;(searchRange=document.createRange()).selectNodeContents(el),searchRange.collapse(!1),(searchSelection=window.getSelection()).removeAllRanges(),searchSelection.addRange(searchRange)},_isPrintable=function(key){return key>47&&key<58||key>64&&key<91||key>95&&key<112||key>185&&key<193||key>218&&key<223},_removeElement=function(elements){!Array.isArray(elements)&&elements instanceof HTMLElement&&(elements=[elements]),"undefined"==typeof jQuery?_forEach(elements,function(element){element in _bound&&(_forEach(_bound[element],function(event,callbacks){_forEach(callbacks,function(callback){try{element.removeEventListener(event,callback,!1)}catch(ex){this.debug("failed to unregister events when removing object")}})}),delete _bound[element]),element.parentNode.removeChild(element)}):_forEach(elements,function(element){jQuery(element).remove(),element in _bound&&delete _bound[element]})},_bound={},_bind=function(element,event,callback){if(!element||"function"!=typeof callback||!event)return!1;element in _bound||(_bound[element]={}),event in _bound[element]||(_bound[element][event]=[]),_bound[element][event].push(callback),element.addEventListener(event,callback,!1)},_isObject=function(variable){return null!==variable&&"object"==typeof variable&&!Array.isArray(variable)},defaultSettings={orderType:"",order:"ASC",placeholder:"---",placeholderOption:"---",search:!1,watch:0,debug:!1},blobSelect=function(element){this.element=element};blobSelect.prototype={_:this,container:null,selections:null,button:null,items:null,search:null,searchValue:null,hash:null,settings:{},watch:null,debounceQueue:{},updateLock:!1,debug:function(msg){return!!this.settings.debug&&(console.log("blobSelect["+(new Date).toISOString().slice(0,19).replace("T"," ")+"] "+msg),!0)},initialized:function(){return this.container instanceof HTMLDivElement},init:function(args){if(this.initialized())return this.debug("already initialized; aborting");args||(args=this.element.dataset.blobselect||!1)||(args={orderType:this.element.dataset.blobselectOrderType||null,order:this.element.dataset.blobselectOrder||null,placeholder:this.element.dataset.blobselectPlaceholder||null,placeholderOption:this.element.dataset.blobselectPlaceholderOption||null,search:this.element.dataset.blobselectSearch||null,watch:this.element.dataset.blobselectWatch||null,debug:this.element.dataset.blobselectDebug||null}),this.saveSettings(args),this.container=document.createElement("div"),this.container.classList.add("blobselect"),this.element.multiple&&this.container.classList.add("is-multiple"),this.container.tabIndex=this.element.tabIndex||0,this.element.parentNode.insertBefore(this.container,this.element),this.debug("built container"),this.selections=document.createElement("div"),this.selections.classList.add("blobselect-selections"),this.container.appendChild(this.selections),this.container.appendChild(this.element),this.button=document.createElement("div"),this.button.classList.add("blobselect-button"),this.container.appendChild(this.button),this.items=document.createElement("div"),this.items.classList.add("blobselect-items"),this.container.appendChild(this.items),this.searchField(),this.updateBuild();var me=this;return this.settings.watch&&(this.debug("watching for changes every "+this.settings.watch/1e3+" seconds"),this.watch=setInterval(function(){me.updateBuild(!1)},this.settings.watch)),_bind(this.element,"change",function(){me.updateLock||(me.debug("element change event fired"),me.updateBuild(!1))}),_bind($("html"),"click",function(e){if(me.debug("click outside"),me.isOpen()){if(null!==_closest(e.target,".blobselect"))return!0;me.close()}}),_bind(this.container,"click",function(e){return me.containerClick(e)}),_bind(this.container,"keyup",function(e){return me.containerKey(e)}),!0},destroy:function(){return this.initialized()?(this.watch&&clearInterval(this.watch),this.search&&_removeElement(this.search),_removeElement($$(".blobselect-item-group, .blobselect-item",this.items)),this.container.parentNode.insertBefore(this.element,this.container),_removeElement(this.container),this.container=null,this.selections=null,this.button=null,this.items=null,this.search=null,this.searchValue=null,this.hash=null,this.settings={},this.watch=null,this.debounceQueue={},this.updateLock=!1,this.debug("natural <select> restored"),!0):this.debug("not initialized; aborting")},saveSettings:function(userSettings){userSettings=_parseJSON(userSettings),_isObject(userSettings)||(userSettings={}),this.settings=_extend(defaultSettings,userSettings),"boolean"!=typeof this.settings.search&&(this.settings.search="string"==typeof this.settings.search&&"true"===this.settings.search.toLowerCase()||"number"==typeof this.settings.search&&this.settings.search),this.settings.order="string"==typeof this.settings.order&&-1!==["ASC","DESC"].indexOf(this.settings.order.toUpperCase())&&this.settings.order.toUpperCase(),this.settings.orderType="string"==typeof this.settings.orderType&&-1!==["string","numeric"].indexOf(this.settings.orderType.toLowerCase())&&this.settings.orderType.toLowerCase(),this.settings.placeholder=_sanitizeWhitespace(this.settings.placeholder),this.settings.placeholderOption=_sanitizeWhitespace(this.settings.placeholderOption),this.settings.watch=parseInt(this.settings.watch,10)||0,this.settings.watch<0&&(this.settings.watch=0),"boolean"!=typeof this.settings.debug&&(this.settings.debug="string"==typeof this.settings.debug&&"true"===this.settings.debug.toLowerCase()||"number"==typeof this.settings.debug&&this.settings.debug),this.debug("using settings: "+JSON.stringify(this.settings)),this.searchField()},searchField:function(){return!!this.initialized()&&(this.settings.search||null===this.search?this.settings.search&&null===this.search&&(this.search=document.createElement("div"),this.search.classList.add("blobselect-item-search"),this.search.setAttribute("type","text"),this.search.setAttribute("contentEditable","true"),this.search.tabIndex=0,this.items.firstChild?this.items.insertBefore(this.search,this.items.firstChild):this.items.appendChild(this.search),this.debug("search field built")):(_removeElement(this.search),this.search=null,this.debug("search field removed")),!0)},debounce:function(key,func,timeout){return void 0!==timeout&&null!==timeout||(timeout=250),void 0!==this.debounceQueue[key]&&null!==this.debounceQueue[key]&&clearTimeout(this.debounceQueue[key]),this.debounceQueue[key]=setTimeout(func(),timeout),!0},updateBuild:function(force){var me=this;return this.debounce("updateBuild",function(){var h=me.getHash(),disabled=me.element.disabled;me.debug("checking for updates"),disabled?me.container.classList.add("is-disabled"):me.container.classList.remove("is-disabled");var keys=Object.keys(selectors),keysLength=keys.length;for(i=0;i<keysLength;i++){var hasIt=me.container.hasAttribute(selectors[keys[i]]),matches=me.element.matches(selectors[keys[i]]);!hasIt&&matches?(me.container.setAttribute(selectors[keys[i]],!0),me.container[selectors[keys[i]]]=!0):hasIt&&!matches&&(me.container.removeAttribute(selectors[keys[i]]),me.container[selectors[keys[i]]]=!1)}(force||h!==me.hash)&&(me.debug("updates found"),me.hash=h,me.updateSelections(),me.updateItems(),me.searchValue=null,me.filterItems())},100)},getHash:function(){if(!this.initialized())return!1;var h=[],attr={},me=this,keys=Object.keys(selectors),keysLength=keys.length;for(i=0;i<keysLength;i++)attr[selectors[keys[i]]]=me.element.matches(selectors[keys[i]]);h.push(attr);var options=$$("option, optgroup",this.element);for(keysLength=(keys=Object.keys(options)).length,i=0;i<keysLength;i++)h.push({value:options[keys[i]].value,label:options[keys[i]].textContent,selected:options[keys[i]].selected,disabled:options[keys[i]].disabled});return _hash(h)},is_placeholder:function(o){if("OPTION"!==o.tagName)return!1;var label=_sanitizeWhitespace(o.textContent),override=parseInt(o.dataset.placeholder,10)||0;return!label.length||1===override||label.toLowerCase()===this.settings.placeholderOption.toLowerCase()},updateItems:function(){if(!this.initialized())return!1;var keys,keysLength,keys2,keys2Length,options,tmp,items=[],me=this,optgroups=$$("optgroup",this.element);if(keys=Object.keys(optgroups),keysLength=keys.length){for(i=0;i<keysLength;i++){for(items.push(optgroups[keys[i]]),tmp=[],options=$$("option",optgroups[keys[i]]),keys2Length=(keys2=Object.keys(options)).length,j=0;j<keys2Length;j++)tmp.push(options[keys2[j]]);for(tmp=me.sortItems(tmp),keys2Length=(keys2=Object.keys(tmp)).length,j=0;j<keys2Length;j++)items.push(tmp[keys2[j]])}for(tmp=[],keysLength=(keys=Object.keys(this.element.children)).length,i=0;i<keysLength;i++)"OPTION"===this.element.children[keys[i]].tagName&&(me.is_placeholder(this.element.children[keys[i]])?items.unshift(this.element.children[keys[i]]):tmp.push(this.element.children[keys[i]]));for(tmp=this.sortItems(tmp),keysLength=(keys=Object.keys(tmp)).length,i=0;i<keysLength;i++)items.push(tmp[keys[i]])}else{for(options=$$("option",this.element),keysLength=(keys=Object.keys(options)).length,i=0;i<keysLength;i++)items.push(options[keys[i]]);items=this.sortItems(items)}_removeElement($$(".blobselect-item-group, .blobselect-item",this.items));var tabindex=1;for(keysLength=(keys=Object.keys(items)).length,i=0;i<keysLength;i++){var el=document.createElement("div");if("OPTGROUP"===items[keys[i]].tagName)el.classList.add("blobselect-item-group"),items[keys[i]].disabled&&el.classList.add("is-disabled"),el.textContent=_sanitizeWhitespace(items[keys[i]].label);else{tabindex++,el.tabIndex=tabindex;var label=_sanitizeWhitespace(items[keys[i]].textContent);el.classList.add("blobselect-item"),items[keys[i]].selected&&el.classList.add("is-active"),"OPTGROUP"===items[keys[i]].parentNode.tagName&&el.classList.add("has-group"),(items[keys[i]].disabled||"OPTGROUP"===items[keys[i]].parentNode.tagName&&items[keys[i]].parentNode.disabled)&&el.classList.add("is-disabled"),el.setAttribute("data-value",items[keys[i]].value),el.setAttribute("data-label",label),me.is_placeholder(items[keys[i]])?(el.classList.add("is-placeholder"),el.textContent=me.settings.placeholderOption):el.textContent=label,_bind(el,"focus",function(e){me.items.setAttribute("data-focused",$$(".blobselect-item",me.items).indexOf(el)),el.classList.add("is-focused")}),_bind(el,"blur",function(e){el.classList.remove("is-focused")})}me.items.appendChild(el)}this.debug("dropdown items rebuilt")},getActiveItem:function(){var choice,me=this,items=$$(".blobselect-item",this.items),focused=parseInt(this.items.dataset.focused,10)||-1;if(-1!==focused&&(choice=items[focused]),!choice||choice.classList.contains("is-disabled")||choice.classList.contains("is-not-match")){choice=null;var keys=Object.keys(items),keysLength=keys.length;for(i=0;i<keysLength;i++)items[keys[i]].classList.contains("is-not-match")||items[keys[i]].classList.contains("is-disabled")||choice||(me.debug('first item "'+items[keys[i]].dataset.value+'"'),choice=items[keys[i]])}return choice},updateSelections:function(){if(!this.initialized())return!1;var s=[],me=this,options=$$("option",this.element),keys=Object.keys(options),keysLength=keys.length;for(i=0;i<keysLength;i++)options[keys[i]].selected&&s.push(options[keys[i]]);for(s=this.sortItems(s);this.selections.firstChild;)_removeElement(this.selections.firstChild);for(keysLength=(keys=Object.keys(s)).length,i=0;i<keysLength;i++){var el=document.createElement("div"),label=_sanitizeWhitespace(s[keys[i]].textContent);el.classList.add("blobselect-selection"),el.setAttribute("data-value",s[keys[i]].value),el.setAttribute("data-label",label),me.is_placeholder(s[keys[i]])?(el.classList.add("is-placeholder"),el.textContent=me.settings.placeholder):el.textContent=label,me.selections.appendChild(el)}this.debug("selections rebuilt")},containerClick:function(e){if(e.stopPropagation(),this.container.classList.contains("is-disabled"))return this.debug("click ignored; field is disabled"),this.isOpen()?this.close():void 0;if(this.debug("clicked"),e.target.classList.contains("blobselect-selection")&&this.element.multiple)return this.unselect(e.target);if(e.target!==this.element)if(e.target.classList.contains("blobselect-item-search"))this.search.setAttribute("contentEditable","true");else{if(!e.target.classList.contains("blobselect-item"))return this.isOpen()?this.close():this.open();e.target.classList.contains("is-disabled")||this.select(e.target)}},containerKey:function(e){var key=e.keyCode,keyMapped={8:"backspace",9:"tab",13:"enter",27:"escape",32:"space",37:"left",38:"up",39:"right",40:"down"}[key]||"other",keyPrintable=_isPrintable(key);if(this.isOpen()){if("escape"===keyMapped)return e.stopPropagation(),this.close();if("enter"===keyMapped){e.stopPropagation(),e.preventDefault(),this.search&&(this.search.innerHTML=_sanitizeWhitespace(this.search.textContent));var choice=this.getActiveItem();return choice?this.select(choice):this.close()}if(-1!==["tab","up","down","left","right"].indexOf(keyMapped)){if(e.stopPropagation(),e.target.classList.contains("blobselect-item-search")){if(-1!==["tab","up","down"].indexOf(keyMapped))return this.traverseItems("current");return}var direction=-1!==["tab","down","right"].indexOf(keyMapped)?"next":"back";return this.traverseItems(direction)}if(e.target.classList.contains("blobselect-item-search")){if(e.stopPropagation(),_sanitizeWhitespace(this.search.textContent).toLowerCase()!==this.searchValue)return this.searchValue=_sanitizeWhitespace(this.search.textContent).toLowerCase(),this.filterItems()}else;}else if(-1===["tab","backspace"].indexOf(keyMapped))return e.stopPropagation(),this.settings.search&&keyPrintable&&(this.search.textContent=String.fromCharCode(key).toLowerCase(),this.searchValue=null,this.filterItems()),this.open()},traverseItems:function(direction){var active=this.getActiveItem(),items=$$(".blobselect-item:not(.is-disabled):not(.is-not-match)",this.items),activeIndex=items.indexOf(active);if(-1===activeIndex){if(!items.length)return;activeIndex=0}return("current"===direction?items[activeIndex]:"back"===direction?activeIndex>0?items[activeIndex-1]:items[0]:activeIndex<items.length-1?items[activeIndex+1]:items[items.length-1]).focus()},isOpen:function(){return this.container.classList.contains("is-open")||this.container.classList.contains("is-opening")},open:function(){var me=this;if(!this.initialized()||this.isOpen())return!0;var selects=$$(".blobselect.is-open select"),keys=Object.keys(selects),keysLength=keys.length;for(i=0;i<keysLength;i++)selects[keys[i]].blobSelect.close();this.items.setAttribute("data-focused",-1),this.container.classList.add("is-opening"),setTimeout(function(){me.container.classList.add("is-open"),me.container.classList.remove("is-opening")},50),me.settings.search&&(me.search.setAttribute("contentEditable","true"),me.search.focus(),_cursorToEnd(me.search)),this.debug("dropdown opened")},close:function(){if(!this.initialized()||!this.isOpen())return!0;this.container.classList.remove("is-open","is-opening"),this.items.setAttribute("data-focused",-1),this.debug("dropdown closed")},triggerChange:function(){this.updateLock=!0;var event=document.createEvent("UIEvents");event.initUIEvent("change",!0,!0,window,1),this.element.dispatchEvent(event),this.updateLock=!1},select:function(o){if(!(this.initialized()&&o instanceof HTMLDivElement&&o.classList.contains("blobselect-item")))return this.close();var value=o.dataset.value||"",options=this.getOptionByValue(value),me=this,keys=Object.keys(options),keysLength=keys.length;if(keysLength)if(this.element.multiple)for(i=0;i<keysLength;i++)options[keys[i]].selected?(options[keys[i]].selected=0,me.debug('unselected: "'+options[keys[i]].value+'"')):(options[keys[i]].selected=1,me.debug('selected: "'+options[keys[i]].value+'"'));else this.element.selectedIndex=options[0].index,this.debug('selected: "'+options[0].value+'"');else this.element.multiple||(this.element.selectedIndex=this.element.firstChild.index,this.debug('selected: "'+this.element.firstChild.value+'"'));this.close(),this.updateBuild(),this.triggerChange()},unselect:function(o){if(!(this.initialized()&&this.element.multiple&&o instanceof HTMLDivElement&&(o.classList.contains("blobselect-selection")||o.classList.contains("blobselect-item"))))return this.close();var value=o.dataset.value||"",options=this.getOptionByValue(value,!0),me=this,keys=Object.keys(options),keysLength=keys.length;if(keysLength)for(i=0;i<keysLength;i++)options[keys[i]].selected=0,me.debug('unselected: "'+options[keys[i]].value+'"');this.close(),this.updateBuild(),this.triggerChange()},getOptionByValue:function(value,allowDisabled){if(!this.initialized())return!1;var found=[],options=$$("option",this.element),keys=Object.keys(options),keysLength=keys.length;for(i=0;i<keysLength;i++)options[keys[i]].value!==value||!allowDisabled&&options[keys[i]].disabled||found.push(options[keys[i]]);return found},filterItems:function(){if(!this.initialized()||!this.settings.search)return!1;var me=this;this.debounce("filterItems",function(){var needle=_sanitizeRegexp(_sanitizeWhitespace(me.search.textContent)),items=$$(".blobselect-item",me.items),matches=0,keys=Object.keys(items),keysLength=keys.length;if(needle.length)for(i=0;i<keysLength;i++){var haystack=items[keys[i]].dataset.label,matchNew=!needle.length||RegExp(needle,"i").test(haystack);items[keys[i]].classList.contains("is-not-match");items[keys[i]].classList.contains("is-placeholder")&&(haystack=me.settings.placeholderOption),items[keys[i]].textContent=haystack,matchNew?(items[keys[i]].classList.remove("is-not-match"),items[keys[i]].classList.add("is-match"),items[keys[i]].innerHTML=haystack.replace(RegExp(needle,"gi"),"<mark>$&</mark>"),matches++):matchNew||(items[keys[i]].classList.add("is-not-match"),items[keys[i]].classList.remove("is-match"))}if(matches)me.debug("items filtered by search term");else for(i=0;i<keysLength;i++)items[keys[i]].classList.remove("is-not-match"),items[keys[i]].innerHTML=items[keys[i]].textContent},100)},sortItems:function(items){if(!(this.initialized()&&this.settings.orderType&&this.settings.order&&Array.isArray(items)&&items.length))return items;var me=this;return items.sort(function(a,b){var aText=a.dataset.label||_sanitizeWhitespace(a.textContent)||_sanitizeWhitespace(a.label),bText=b.dataset.label||_sanitizeWhitespace(b.textContent)||_sanitizeWhitespace(b.label);return aText.toLowerCase()===me.settings.placeholderOption.toLowerCase()&&(aText="numeric"===me.settings.orderType?0:""),bText.toLowerCase()===me.settings.placeholderOption.toLowerCase()&&(bText="numeric"===me.settings.orderType?0:""),"numeric"===me.settings.orderType&&(aText=Number(aText.replace(/[^\d\.]/g,""))||0,bText=Number(bText.replace(/[^\d\.]/g,""))||0),aText===bText?0:"ASC"===me.settings.order?aText<bText?-1:1:aText>bText?-1:1}),items}},Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:function getter(){return Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:void 0}),Object.defineProperty(this,"blobSelect",{value:new blobSelect(this)}),Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:getter}),this.blobSelect},configurable:!0}),document.addEventListener("DOMContentLoaded",function(){var matches=$$("select[data-blobselect], select[data-blobselect-watch], select[data-blobselect-search], select[data-blobselect-placeholder], select[data-blobselect-placeholder-option], select[data-blobselect-order], select[data-blobselect-order-type], select[data-blobselect-debug]");_forEach(matches,function(select){select.blobSelect.init()})})}else console.warn("blobSelect["+(new Date).toISOString().slice(0,19).replace("T"," ")+"] aborted; browser missing feature support")}();
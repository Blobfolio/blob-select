!function(){function _hash(key,seed){var remainder,bytes,h1,h1b,c1,c2,k1,i;for("object"==typeof key&&(key=JSON.stringify(key)),remainder=3&key.length,bytes=key.length-remainder,h1=seed,c1=3432918353,c2=461845907,i=0;i<bytes;)k1=255&key.charCodeAt(i)|(255&key.charCodeAt(++i))<<8|(255&key.charCodeAt(++i))<<16|(255&key.charCodeAt(++i))<<24,++i,k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1,h1=h1<<13|h1>>>19,h1b=5*(65535&h1)+((5*(h1>>>16)&65535)<<16)&4294967295,h1=(65535&h1b)+27492+(((h1b>>>16)+58964&65535)<<16);switch(k1=0,remainder){case 3:k1^=(255&key.charCodeAt(i+2))<<16;break;case 2:k1^=(255&key.charCodeAt(i+1))<<8;break;case 1:k1^=255&key.charCodeAt(i),k1=(65535&k1)*c1+(((k1>>>16)*c1&65535)<<16)&4294967295,k1=k1<<15|k1>>>17,k1=(65535&k1)*c2+(((k1>>>16)*c2&65535)<<16)&4294967295,h1^=k1}return h1^=key.length,h1^=h1>>>16,h1=2246822507*(65535&h1)+((2246822507*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>13,h1=3266489909*(65535&h1)+((3266489909*(h1>>>16)&65535)<<16)&4294967295,h1^=h1>>>16,h1>>>0}if(!("classList"in document.documentElement&&"createRange"in document&&"querySelector"in document&&"querySelectorAll"in document&&"JSON"in window&&"parse"in JSON&&"stringify"in JSON))return void console.warn("blobSelect["+(new Date).toISOString().slice(0,19).replace("T"," ")+"] aborted; browser missing feature support");Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(s){for(var matches=(this.document||this.ownerDocument).querySelectorAll(s),i=matches.length;--i>=0&&matches.item(i)!==this;);return i>-1});var $=function(expr,con){return expr?"string"==typeof expr?(con||document).querySelector(expr):expr:null},$$=function(expr,con){return Array.prototype.slice.call((con||document).querySelectorAll(expr))},_extend=function(defaults,overrides){var extended={};return _forEach(defaults,function(v,k){extended[k]=defaults[k]}),_forEach(overrides,function(v,k){void 0!==extended[k]&&void 0!==v&&null!==v&&(extended[k]=overrides[k])}),extended},_closest=function(el,selector){try{if(el.matches(selector))return el;for(;el.parentNode&&"matches"in el.parentNode;)if(el=el.parentNode,el.matches(selector))return el}catch(Ex){}return null},_forEach=function(collection,callback){if("[object Object]"===Object.prototype.toString.call(collection))for(var key in collection)Object.prototype.hasOwnProperty.call(collection,key)&&callback(collection[key],key,collection);else for(var akey=0,len=collection.length;akey<len;akey++)callback(collection[akey],akey,collection)},_sanitizeRegexp=function(s){return s.replace(/[-\\^$*+?.()|[\]{}]/g,"\\$&")},_sanitizeWhitespace=function(str,trim){return str=str.replace(/\s{1,}/gm," "),str.trim()},_parseJSON=function(str){if(_isObject(str))return str;try{var j=JSON.parse(str);return j}catch(e){return{}}},_cursorToEnd=function(el){var searchRange,searchSelection;searchRange=document.createRange(),searchRange.selectNodeContents(el),searchRange.collapse(!1),searchSelection=window.getSelection(),searchSelection.removeAllRanges(),searchSelection.addRange(searchRange)},_isPrintable=function(key){return key>47&&key<58||key>64&&key<91||key>95&&key<112||key>185&&key<193||key>218&&key<223},_removeElement=function(elements){return!Array.isArray(elements)&&elements instanceof HTMLElement&&(elements=[elements]),"undefined"!=typeof jQuery?void _forEach(elements,function(element){jQuery(element).remove(),element in _bound&&delete _bound[element]}):void _forEach(elements,function(element){element in _bound&&(_forEach(_bound[element],function(event,callbacks){_forEach(callbacks,function(callback){try{element.removeEventListener(event,callback,!1)}catch(ex){this.debug("failed to unregister events when removing object")}})}),delete _bound[element]),element.parentNode.removeChild(element)})},_bound={},_bind=function(element,event,callback){return!(!element||"function"!=typeof callback||!event)&&(element in _bound||(_bound[element]={}),event in _bound[element]||(_bound[element][event]=[]),_bound[element][event].push(callback),void element.addEventListener(event,callback,!1))},_isObject=function(variable){return null!==variable&&"object"==typeof variable&&!Array.isArray(variable)},defaultSettings={orderType:"",order:"ASC",placeholder:"---",placeholderOption:"---",search:!1,watch:0,debug:!1},blobSelect=function(element){this.element=element};blobSelect.prototype={_:this,container:null,selections:null,button:null,items:null,search:null,searchValue:null,hash:null,settings:{},watch:null,debounceQueue:{},updateLock:!1,debug:function(msg){return!!this.settings.debug&&(console.log("blobSelect["+(new Date).toISOString().slice(0,19).replace("T"," ")+"] "+msg),!0)},initialized:function(){return this.container instanceof HTMLDivElement},init:function(args){if(this.initialized())return this.debug("already initialized; aborting");args||(args=this.element.getAttribute("data-blobselect")||!1,args||(args={orderType:this.element.getAttribute("data-blobselect-order-type")||null,order:this.element.getAttribute("data-blobselect-order")||null,placeholder:this.element.getAttribute("data-blobselect-placeholder")||null,placeholderOption:this.element.getAttribute("data-blobselect-placeholder-option")||null,search:this.element.getAttribute("data-blobselect-search")||null,watch:this.element.getAttribute("data-blobselect-watch")||null,debug:this.element.getAttribute("data-blobselect-debug")||null})),this.saveSettings(args),this.container=document.createElement("div"),this.container.classList.add("blobselect"),this.element.multiple&&this.container.classList.add("is-multiple"),this.container.tabIndex=this.element.tabIndex||0,this.element.parentNode.insertBefore(this.container,this.element),this.debug("built container"),this.selections=document.createElement("div"),this.selections.classList.add("blobselect-selections"),this.container.appendChild(this.selections),this.container.appendChild(this.element),this.button=document.createElement("div"),this.button.classList.add("blobselect-button"),this.container.appendChild(this.button),this.items=document.createElement("div"),this.items.classList.add("blobselect-items"),this.container.appendChild(this.items),this.searchField(),this.updateBuild();var me=this;return this.settings.watch&&(this.debug("watching for changes every "+this.settings.watch/1e3+" seconds"),this.watch=setInterval(function(){me.updateBuild(!1)},this.settings.watch)),_bind(this.element,"change",function(){me.updateLock||(me.debug("element change event fired"),me.updateBuild(!1))}),_bind($("html"),"click",function(e){if(me.debug("click outside"),me.isOpen()){if(null!==_closest(e.target,".blobselect"))return!0;me.close()}}),_bind(this.container,"click",function(e){return me.containerClick(e)}),_bind(this.container,"keyup",function(e){return me.containerKey(e)}),!0},destroy:function(){return this.initialized()?(this.watch&&clearInterval(this.watch),this.search&&_removeElement(this.search),_removeElement($$(".blobselect-item-group, .blobselect-item",this.items)),this.container.parentNode.insertBefore(this.element,this.container),_removeElement(this.container),this.container=null,this.selections=null,this.button=null,this.items=null,this.search=null,this.searchValue=null,this.hash=null,this.settings={},this.watch=null,this.debounceQueue={},this.updateLock=!1,this.debug("natural <select> restored"),!0):this.debug("not initialized; aborting")},saveSettings:function(userSettings){userSettings=_parseJSON(userSettings),_isObject(userSettings)||(userSettings={}),this.settings=_extend(defaultSettings,userSettings),"boolean"!=typeof this.settings.search&&(this.settings.search="string"==typeof this.settings.search&&"true"===this.settings.search.toLowerCase()||"number"==typeof this.settings.search&&this.settings.search),this.settings.order="string"==typeof this.settings.order&&["ASC","DESC"].indexOf(this.settings.order.toUpperCase())!==-1&&this.settings.order.toUpperCase(),this.settings.orderType="string"==typeof this.settings.orderType&&["string","numeric"].indexOf(this.settings.orderType.toLowerCase())!==-1&&this.settings.orderType.toLowerCase(),this.settings.placeholder=_sanitizeWhitespace(this.settings.placeholder),this.settings.placeholderOption=_sanitizeWhitespace(this.settings.placeholderOption),this.settings.watch=parseInt(this.settings.watch,10)||0,this.settings.watch<0&&(this.settings.watch=0),"boolean"!=typeof this.settings.debug&&(this.settings.debug="string"==typeof this.settings.debug&&"true"===this.settings.debug.toLowerCase()||"number"==typeof this.settings.debug&&this.settings.debug),this.debug("using settings: "+JSON.stringify(this.settings)),this.searchField()},searchField:function(){return!!this.initialized()&&(this.settings.search||null===this.search?this.settings.search&&null===this.search&&(this.search=document.createElement("div"),this.search.classList.add("blobselect-item-search"),this.search.setAttribute("type","text"),this.search.setAttribute("contentEditable","true"),this.search.tabIndex=0,this.items.firstChild?this.items.insertBefore(this.search,this.items.firstChild):this.items.appendChild(this.search),this.debug("search field built")):(_removeElement(this.search),this.search=null,this.debug("search field removed")),!0)},debounce:function(key,func,timeout){return void 0!==timeout&&null!==timeout||(timeout=250),void 0!==this.debounceQueue[key]&&null!==this.debounceQueue[key]&&clearTimeout(this.debounceQueue[key]),this.debounceQueue[key]=setTimeout(func(),timeout),!0},updateBuild:function(force){var me=this;return this.debounce("updateBuild",function(){var h=me.getHash(),disabled=me.element.disabled;me.debug("checking for updates"),disabled?me.container.classList.add("is-disabled"):me.container.classList.remove("is-disabled"),(force||h!==me.hash)&&(me.debug("updates found"),me.hash=h,me.updateSelections(),me.updateItems(),me.searchValue=null,me.filterItems())},100)},getHash:function(){if(!this.initialized())return!1;var h=[];return _forEach($$("option, optgroup",this.element),function(o){h.push({value:o.value,label:o.textContent,selected:o.selected,disabled:o.disabled})}),_hash(h)},is_placeholder:function(o){if("OPTION"!==o.tagName)return!1;var label=_sanitizeWhitespace(o.textContent),override=parseInt(o.getAttribute("data-placeholder"),10)||0;return!label.length||1===override||label.toLowerCase()===this.settings.placeholderOption.toLowerCase()},updateItems:function(){if(!this.initialized())return!1;var i=[],me=this;if(optgroup=$$("optgroup",this.element).length,optgroup){_forEach($$("optgroup",this.element),function(o){i.push(o);var tmp=[];_forEach($$("option",o),function(o2){tmp.push(o2)}),tmp=me.sortItems(tmp),_forEach(tmp,function(o2){i.push(o2)})});var tmp=[];_forEach(this.element.children,function(o){"OPTION"===o.tagName&&(me.is_placeholder(o)?i.unshift(o):tmp.push(o))}),tmp=this.sortItems(tmp),_forEach(tmp,function(o){i.push(o)})}else _forEach($$("option",this.element),function(o){i.push(o)}),i=this.sortItems(i);_removeElement($$(".blobselect-item-group, .blobselect-item",this.items));var tabindex=1;_forEach(i,function(o){var el=document.createElement("div");if("OPTGROUP"===o.tagName)el.classList.add("blobselect-item-group"),o.disabled&&el.classList.add("is-disabled"),el.textContent=_sanitizeWhitespace(o.label);else{tabindex++,el.tabIndex=tabindex;var label=_sanitizeWhitespace(o.textContent);el.classList.add("blobselect-item"),o.selected&&el.classList.add("is-active"),"OPTGROUP"===o.parentNode.tagName&&el.classList.add("has-group"),(o.disabled||"OPTGROUP"===o.parentNode.tagName&&o.parentNode.disabled)&&el.classList.add("is-disabled"),el.setAttribute("data-value",o.value),el.setAttribute("data-label",label),me.is_placeholder(o)?(el.classList.add("is-placeholder"),el.textContent=me.settings.placeholderOption):el.textContent=label,_bind(el,"focus",function(e){me.items.setAttribute("data-focused",$$(".blobselect-item",me.items).indexOf(el)),el.classList.add("is-focused")}),_bind(el,"blur",function(e){el.classList.remove("is-focused")})}me.items.appendChild(el)}),this.debug("dropdown items rebuilt")},getActiveItem:function(){var choice,me=this,items=$$(".blobselect-item",this.items),focused=parseInt(this.items.getAttribute("data-focused"),10)||-1;return focused!==-1&&(choice=items[focused]),(!choice||choice.classList.contains("is-disabled")||choice.classList.contains("is-not-match"))&&(choice=null,_forEach(items,function(item){item.classList.contains("is-not-match")||item.classList.contains("is-disabled")||choice||(me.debug('first item "'+item.getAttribute("data-value")+'"'),choice=item)})),choice},updateSelections:function(){if(!this.initialized())return!1;var s=[],me=this;for(_forEach($$("option",this.element),function(o){o.selected&&s.push(o)}),s=this.sortItems(s);this.selections.firstChild;)_removeElement(this.selections.firstChild);_forEach(s,function(o){var el=document.createElement("div"),label=_sanitizeWhitespace(o.textContent);el.classList.add("blobselect-selection"),el.setAttribute("data-value",o.value),el.setAttribute("data-label",label),me.is_placeholder(o)?(el.classList.add("is-placeholder"),el.textContent=me.settings.placeholder):el.textContent=label,me.selections.appendChild(el)}),this.debug("selections rebuilt")},containerClick:function(e){return e.stopPropagation(),this.container.classList.contains("is-disabled")?(this.debug("click ignored; field is disabled"),this.isOpen()?this.close():void 0):(this.debug("clicked"),e.target.classList.contains("blobselect-selection")&&this.element.multiple?this.unselect(e.target):e.target!==this.element?e.target.classList.contains("blobselect-item-search")?void this.search.setAttribute("contentEditable","true"):e.target.classList.contains("blobselect-item")?void(e.target.classList.contains("is-disabled")||this.select(e.target)):this.isOpen()?this.close():this.open():void 0)},containerKey:function(e){var key=e.keyCode,map={8:"backspace",9:"tab",13:"enter",27:"escape",32:"space",37:"left",38:"up",39:"right",40:"down"},keyMapped=map[key]||"other",keyPrintable=_isPrintable(key);if(this.isOpen()){if("escape"===keyMapped)return e.stopPropagation(),this.close();if("enter"===keyMapped){e.stopPropagation(),e.preventDefault(),this.search&&(this.search.innerHTML=_sanitizeWhitespace(this.search.textContent));var choice=this.getActiveItem();return choice?this.select(choice):this.close()}if(["tab","up","down","left","right"].indexOf(keyMapped)!==-1){if(e.stopPropagation(),e.target.classList.contains("blobselect-item-search")){if(["tab","up","down"].indexOf(keyMapped)!==-1)return this.traverseItems("current");return}var direction=["tab","down","right"].indexOf(keyMapped)!==-1?"next":"back";return this.traverseItems(direction)}if(e.target.classList.contains("blobselect-item-search")){if(e.stopPropagation(),_sanitizeWhitespace(this.search.textContent).toLowerCase()!==this.searchValue)return this.searchValue=_sanitizeWhitespace(this.search.textContent).toLowerCase(),this.filterItems()}else;}else if(["tab","backspace"].indexOf(keyMapped)===-1)return e.stopPropagation(),this.settings.search&&keyPrintable&&(this.search.textContent=String.fromCharCode(key).toLowerCase(),this.searchValue=null,this.filterItems()),this.open()},traverseItems:function(direction){var active=this.getActiveItem(),items=$$(".blobselect-item:not(.is-disabled):not(.is-not-match)",this.items),activeIndex=items.indexOf(active),choice=null;if(activeIndex===-1){if(!items.length)return;activeIndex=0}return choice="current"===direction?items[activeIndex]:"back"===direction?activeIndex>0?items[activeIndex-1]:items[0]:activeIndex<items.length-1?items[activeIndex+1]:items[items.length-1],choice.focus()},isOpen:function(){return this.container.classList.contains("is-open")||this.container.classList.contains("is-opening")},open:function(){var me=this;return!(this.initialized()&&!this.isOpen())||(_forEach($$(".blobselect.is-open select"),function(s){s.blobSelect.close()}),this.items.setAttribute("data-focused",-1),this.container.classList.add("is-opening"),setTimeout(function(){me.container.classList.add("is-open"),me.container.classList.remove("is-opening")},50),me.settings.search&&(me.search.setAttribute("contentEditable","true"),me.search.focus(),_cursorToEnd(me.search)),void this.debug("dropdown opened"))},close:function(){return!this.initialized()||!this.isOpen()||(this.container.classList.remove("is-open","is-opening"),this.container.focus(),this.items.setAttribute("data-focused",-1),void this.debug("dropdown closed"))},triggerChange:function(){this.updateLock=!0;var event=document.createEvent("UIEvents");event.initUIEvent("change",!0,!0,window,1),this.element.dispatchEvent(event),this.updateLock=!1},select:function(o){if(!(this.initialized()&&o instanceof HTMLDivElement&&o.classList.contains("blobselect-item")))return this.close();var value=o.getAttribute("data-value")||"",options=this.getOptionByValue(value),me=this;options.length?this.element.multiple?_forEach(options,function(option){option.selected?(option.selected=0,me.debug('unselected: "'+option.value+'"')):(option.selected=1,me.debug('selected: "'+option.value+'"'))}):(this.element.selectedIndex=options[0].index,this.debug('selected: "'+options[0].value+'"')):this.element.multiple||(this.element.selectedIndex=this.element.firstChild.index,this.debug('selected: "'+this.element.firstChild.value+'"')),this.close(),this.updateBuild(),this.triggerChange()},unselect:function(o){if(!(this.initialized()&&this.element.multiple&&o instanceof HTMLDivElement&&(o.classList.contains("blobselect-selection")||o.classList.contains("blobselect-item"))))return this.close();var value=o.getAttribute("data-value")||"",options=this.getOptionByValue(value,!0),me=this;options.length&&_forEach(options,function(option){option.selected=0,me.debug('unselected: "'+option.value+'"')}),this.close(),this.updateBuild(),this.triggerChange()},getOptionByValue:function(value,allowDisabled){if(!this.initialized())return!1;var found=[];return _forEach($$("option",this.element),function(option){option.value!==value||!allowDisabled&&option.disabled||found.push(option)}),found},filterItems:function(){if(!this.initialized()||!this.settings.search)return!1;var me=this;this.debounce("filterItems",function(){var needle=_sanitizeRegexp(_sanitizeWhitespace(me.search.textContent)),items=$$(".blobselect-item",me.items),matches=0;needle.length&&_forEach(items,function(item){var haystack=item.getAttribute("data-label"),matchNew=!needle.length||RegExp(needle,"i").test(haystack);!item.classList.contains("is-not-match");item.classList.contains("is-placeholder")&&(haystack=me.settings.placeholderOption),item.textContent=haystack,matchNew?(item.classList.remove("is-not-match"),item.classList.add("is-match"),item.innerHTML=haystack.replace(RegExp(needle,"gi"),"<mark>$&</mark>"),matches++):matchNew||(item.classList.add("is-not-match"),item.classList.remove("is-match"))}),matches?me.debug("items filtered by search term"):_forEach(items,function(item){item.classList.remove("is-not-match"),item.innerHTML=item.textContent})},100)},sortItems:function(items){if(!(this.initialized()&&this.settings.orderType&&this.settings.order&&Array.isArray(items)&&items.length))return items;var me=this;return items.sort(function(a,b){var aText=a.getAttribute("data-label")||_sanitizeWhitespace(a.textContent)||_sanitizeWhitespace(a.label),bText=b.getAttribute("data-label")||_sanitizeWhitespace(b.textContent)||_sanitizeWhitespace(b.label);return aText.toLowerCase()===me.settings.placeholderOption.toLowerCase()&&(aText="numeric"===me.settings.orderType?0:""),bText.toLowerCase()===me.settings.placeholderOption.toLowerCase()&&(bText="numeric"===me.settings.orderType?0:""),"numeric"===me.settings.orderType&&(aText=Number(aText.replace(/[^\d\.]/g,""))||0,bText=Number(bText.replace(/[^\d\.]/g,""))||0),aText===bText?0:"ASC"===me.settings.order?aText<bText?-1:1:aText>bText?-1:1}),items}},Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:function getter(){return Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:void 0}),Object.defineProperty(this,"blobSelect",{value:new blobSelect(this)}),Object.defineProperty(HTMLSelectElement.prototype,"blobSelect",{get:getter}),this.blobSelect},configurable:!0}),document.addEventListener("DOMContentLoaded",function(){var matches=$$("select[data-blobselect], select[data-blobselect-watch], select[data-blobselect-search], select[data-blobselect-placeholder], select[data-blobselect-placeholder-option], select[data-blobselect-order], select[data-blobselect-order-type], select[data-blobselect-debug]");_forEach(matches,function(select){select.blobSelect.init()})})}();